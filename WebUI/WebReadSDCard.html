<!DOCTYPE HTML>
    <html lang="en">
        <head>
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <meta charset="UTF-8">
            <style>
                .rocket {
                    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAA3VJREFUOE+tlG1Mk1cUx//3eW9LoZShhMVNNzWM6tD48sG9wD6AOonMN9ToCG4Gs82gwCaaSNbxBV2Mkm24DGPmS6biCxh1C6JREbvInFtYmMRNbFGGDdppR7un7fPc5y5tAhlzVsx2v91z7/2dc+75n0PwPy/yX3nOlq3pzrzKvkHOEwO39xxwfHmmoVNnKsA4ECbC4hewMX9N+qLMOXdGDGSMkWU7117qFryzfKYglBQzVEohchYk3CNYOHpGQdXc9SdGBHQzt7JiR9XvEYWaWDAIQ2a3BxLZGGY3IwADis9AxeT540unF3c/Evhz/3dpcqrd4MHbV2xd1xWxW5Ax8QXsz67iCCHsrbbqrFZ3R5tuk63C3RC6326MsYaA0SjO/taxb+/5xiXee3eREOYwK3smXO52GAbAeikaKptlByGRwQJMrVt2UbOQV5Qg/fr79w7nDwH9zG/f3FDja/N2IJJqQYBqmJc9B64rbehnd5BssQLXVZxYv1OZQCaEB4GOLQXUalK4y+sahgIjjDHlUGvjtdoLu8axUTI0HXg1N/cTV9ePpffpADT+T8giDyEMjLc+g/K8ctMojDUqWsoP93k8BQ4+/djB1XWLh2TDGJMu3fhh/3lPa2FGztST127+2nPmiutdHx/mNJlCUggCwQEIHAEf5iAFJKgPgjDbJKRQBRffOTKsDrFNNEoV6lMe9NOln5b2aWkSeFEGZRHoXASUarCIJoTUMAyDg00Xkdpv4HRF00NFHWZgjPGvH19z43qod6wgCCA8QYjTIUsmCKoOnnDQOSDxDw7tRUf/VSEPGatvfl54uefqm123u/KJ1QJVNEGAAHOEgvqDsJlTkP3czLPbppfNJoQY/2zdYcCs0teYNSPJSMsck+M3HnBun/eCZkqOyUb2B5CelALH5Gkfntv7zUdNG3ZVZpqf/TguMHo4pXYu0xMYOlc3k5yTq5Z6/PcPSbyI0byEzElZE09ddf3Ce8O49UFz/JRLtpQk1W+s90eh0z5boAoDWnX7plM184+tfclzq3fGT2XHa1+se4Np9kQkh0R8u2r34/9widMpHXE6Y52Q9/6CSS3bmjr/ntKU7cuZwEnYULTSVmjPjTl/bMrx5uPLNcXM8fTzX31RVLXyUfdGNG0GH+84vaekbHZxfTynTwSM6pQQQuMB/wLJw2AkLJLNsAAAAABJRU5ErkJggg==');
                    background-repeat: no-repeat;
                    background-size: 20px;
                    background-position: center;
                    width: 20px;
                    height: 16px;
                    display: inline-block;
                }

                .gg-rename {
                    box-sizing: border-box;
                    position: relative;
                    display: inline-block;
                    width: 20px;
                    height: 16px;
                    transform: scale(var(--ggs, 1));
                    background:
                        linear-gradient(to left, currentColor 22px,
                            transparent 0) no-repeat 6px center/2px 22px
                }

                .gg-rename::after,
                .gg-rename::before {
                    content: "";
                    display: block;
                    box-sizing: border-box;
                    position: absolute;
                    width: 6px;
                    height: 12px;
                    border: 2px solid;
                    top: 2px
                }

                .gg-rename::before {
                    border-right: 0;
                    border-top-left-radius: 3px;
                    border-bottom-left-radius: 3px
                }

                .gg-rename::after {
                    width: 10px;
                    border-left: 0;
                    border-top-right-radius: 3px;
                    border-bottom-right-radius: 3px;
                    right: 0
                }

                .gg-folder {
                    cursor: pointer;
                    transform: scale(var(--ggs, 1))
                }

                .gg-folder,
                .gg-folder::after {
                    box-sizing: border-box;
                    position: relative;
                    display: inline-block;
                    width: 22px;
                    height: 16px;
                    border: 2px solid;
                    border-radius: 3px
                }

                .gg-folder::after {
                    content: "";
                    position: absolute;
                    width: 10px;
                    height: 4px;
                    border-bottom: 0;
                    border-top-left-radius: 2px;
                    border-top-right-radius: 4px;
                    border-bottom-left-radius: 0;
                    border-bottom-right-radius: 0;
                    top: -5px
                }

                .gg-trash {
                    box-sizing: border-box;
                    position: relative;
                    display: inline-block;
                    transform: scale(var(--ggs, 1));
                    width: 10px;
                    height: 12px;
                    border: 2px solid transparent;
                    box-shadow:
                        0 0 0 2px,
                        inset -2px 0 0,
                        inset 2px 0 0;
                    border-bottom-left-radius: 1px;
                    border-bottom-right-radius: 1px;
                    margin-top: 4px;
                    margin-bottom: 2px;
                    cursor: pointer;
                }

                .gg-trash::after,
                .gg-trash::before {
                    content: "";
                    display: block;
                    box-sizing: border-box;
                    position: absolute
                }

                .gg-trash::after {
                    background: currentColor;
                    border-radius: 3px;
                    width: 16px;
                    height: 2px;
                    top: -4px;
                    left: -5px
                }

                .gg-trash::before {
                    width: 10px;
                    height: 4px;
                    border: 2px solid;
                    border-bottom: transparent;
                    border-top-left-radius: 2px;
                    border-top-right-radius: 2px;
                    top: -7px;
                    left: -2px
                }

                .gg-arrow-down-r {
                    box-sizing: border-box;
                    position: relative;
                    display: inline-block;
                    width: 22px;
                    height: 22px;
                    border: 2px solid;
                    transform: scale(var(--ggs, 1));
                    cursor: pointer;
                    border-radius: 4px
                }

                .gg-arrow-down-r::after,
                .gg-arrow-down-r::before {
                    content: "";
                    display: block;
                    box-sizing: border-box;
                    position: absolute;
                    bottom: 4px
                }

                .gg-arrow-down-r::after {
                    width: 6px;
                    height: 6px;
                    border-bottom: 2px solid;
                    border-left: 2px solid;
                    transform: rotate(-45deg);
                    left: 6px
                }

                .gg-arrow-down-r::before {
                    width: 2px;
                    height: 10px;
                    left: 8px;
                    background: currentColor
                }

                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                    margin: 0;
                    padding: 5px;
                    color: #00dd00;
                    background-color: #202124;
                }

                .container {
                    max-width: 800px;
                    margin: 5px auto;
                    padding: 0 5px;
                }

                h3 {
                    margin: 0;
                    padding: 10px 0;
                    border-bottom: 1px solid #00cc00;
                }

                table {
                    width: 100%;
                    border-collapse: collapse;
                    border-bottom: 1px solid #00cc00;
                }

                p {
                    margin-block-start: 3px;
                    margin-block-end: 3px;
                }

                th,
                td {
                    padding: 5px;
                    border-bottom: 1px solid #00cc00;
                }

                th {
                    text-align: left;
                }

                a {
                    color: #e0d204;
                    text-decoration: none;
                }

                a:hover {
                    text-decoration: underline;
                    cursor: pointer;
                }

                button {
                    background-color: #303134;
                    color: #00dd00;
                    border: 2px solid;
                    padding: 4px 8px;
                    border-radius: 4px;
                    border-color: #00dd00;
                    cursor: pointer;
                    margin: 5px;
                }

                button:hover {
                    background-color: #292a2c;
                }

                #detailsheader,
                #updetailsheader {
                    justify-content: space-between;
                }

                @media (max-width: 768px) {
                    body {
                        font-size: 14px;
                    }

                    table {
                        font-size: 12px;
                    }

                    th,
                    td {
                        padding: 5px;
                    }

                    button {
                        font-size: 12px;
                        padding: 6px 12px;
                    }
                }

                th:first-child,
                td:first-child {
                    width: 65%;
                }

                th:last-child,
                td:last-child {
                    width: 100px;
                    text-align: center;
                }

                .float-element {
                    position: absolute;
                    top: 10px;
                    /* Ajuste conforme necessário */
                    right: 10px;
                    /* Ajuste conforme necessário */
                    font-size: 16px;
                }

                .drop-area {
                    border: 2px dashed #00dd00;
                    padding: 3px;
                    margin-top: 2px;
                    display: none;
                }

                .highlight {
                    background-color: #303134;
                    color: #ad007c65;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1 align="center">-= SD CARD FOR ESP32 =-</h1>
                <p>Firmware version: <span id="firmwareVersion">...</span></p>
                <p>SD Free Storage: <span id="freeSD">...</span> | Used: <span
                        id="usedSD">...</span> | Total: <span
                        id="totalSD">...</span></p>
                <div>
                    <form id="save" enctype="multipart/form-data"
                        method="post"><input type="hidden" id="actualFolder"
                            name="actualFolder" value="/"></form>
                    <button onclick="rebootButton()">Reboot</button>
                    <button onclick="listFilesButton('/')">SD Files</button>

                </div>
                <p id="detailsheader"></p>
                <p id="status"></p>
                <div id="drop-area" class="drop-area">
                    <p id="details"></p>
                </div>
                <p id="updetailsheader"></p>
                <p id="updetails"></p>
            </div>
            <script>
                function _(e) { return document.getElementById(e); }
                function startUpdate(fileName) {
                    const ajax4 = new XMLHttpRequest();
                    const formdata4 = new FormData();
                    formdata4.append("fileName", fileName);
                    ajax4.open("POST", "/UPDATE", false);
                    ajax4.send(formdata4);
                }
                function rebootButton() {
                    if (confirm("Confirm Restart?!")) {
                        xmlhttp = new XMLHttpRequest();
                        var xhr = new XMLHttpRequest();
                        xhr.open("GET", "/reboot", true);
                        xhr.send();
                    }
                }
                function systemInfo() {
                    const xmlhttp = new XMLHttpRequest();
                    xmlhttp.onload = function () {
                        if (xmlhttp.status === 200) {
                            try {
                                const data = JSON.parse(xmlhttp.responseText);
                                _("firmwareVersion").innerHTML = data.VERSION;
                                _("freeSD").innerHTML = data.SD.free;
                                _("usedSD").innerHTML = data.SD.used;
                                _("totalSD").innerHTML = data.SD.total;
                            } catch (error) {
                                console.error("JSON Parsing Error: ", error);
                            }
                        } else {
                            console.error("Request Error: " + xmlhttp.status);
                        }
                    };
                    xmlhttp.onerror = function () {
                        console.error("Network error or request failure.");
                    };
                    xmlhttp.open("GET", "/systeminfo", true);
                    xmlhttp.send();
                }
                function listFilesButton(folders) {
                    var xmlhttp = new XMLHttpRequest();
                    _("drop-area").style.display = 'block';
                    _("actualFolder").value = folders;

                    var PreFolder = folders.substring(0, folders.lastIndexOf('/'));
                    if (PreFolder == "") PreFolder = "/";

                    xmlhttp.onload = function () {
                        if (xmlhttp.status === 200) {
                            var responseText = xmlhttp.responseText;
                            var lines = responseText.split('\n');
                            var tableContent = "<table><tr><th align='left'>Name</th><th style=\"text-align=center;\">Size</th><th></th></tr>\n";
                            tableContent += "<tr><th align='left'><a onclick=\"listFilesButton('" + PreFolder + "')\" href='javascript:void(0);'>... </a></th><th align='left'></th><th></th></tr>\n";

                            var folder = folders;  // giữ đúng folder hiện tại
                            var foldersArray = [];
                            var filesArray = [];
                            lines.forEach(function (line) {
                                if (line) {
                                    var type = line.substring(0, 2);
                                    var content = line.substring(3);

                                    if (type === "Fo") {
                                        var fullPath = folder + "/" + content;
                                        if (!fullPath.startsWith("/")) fullPath = "/" + fullPath;
                                        foldersArray.push({ path: fullPath, name: content });
                                    } else if (type === "Fi") {
                                        var sepIndex = content.lastIndexOf(':');
                                        var filename = content.substring(0, sepIndex);
                                        var size = content.substring(sepIndex + 1).trim();
                                        var fullPath = folder + "/" + filename;
                                        if (!fullPath.startsWith("/")) fullPath = "/" + fullPath;
                                        filesArray.push({ path: fullPath, name: filename, size: size });
                                    }
                                }
                            });
                            foldersArray.sort((a, b) => a.name.localeCompare(b.name));
                            filesArray.sort((a, b) => a.name.localeCompare(b.name));

                            foldersArray.forEach(function (item) {
                                tableContent += "<tr align='left'><td><a onclick=\"listFilesButton('" + item.path + "')\" href='javascript:void(0);'>" + item.name + "</a></td>";
                                tableContent += "<td></td>\n";
                                tableContent += "<td><i style=\"color: #e0d204;\" class=\"gg-folder\" onclick=\"listFilesButton('" + item.path + "')\"></i>&nbsp&nbsp";
                                tableContent += "<i style=\"color: #e0d204;\" class=\"gg-rename\" onclick=\"renameFile('" + item.path + "', '" + item.name + "')\"></i>&nbsp&nbsp";
                                tableContent += "<i style=\"color: #e0d204;\" class=\"gg-trash\" onclick=\"downloadDeleteButton('" + item.path + "', 'delete')\"></i></td></tr>\n\n";
                            });

                            filesArray.forEach(function (item) {
                                tableContent += "<tr align='left'><td>" + item.name;
                                if (item.name.substring(item.name.lastIndexOf('.') + 1).toLowerCase() === "bin") {
                                    tableContent += "&nbsp<i class=\"rocket\" onclick=\"startUpdate('" + item.path + "')\"></i>";
                                }
                                tableContent += "</td>\n";
                                tableContent += "<td style=\"font-size: 10px; text-align=center;\">" + item.size + "</td>\n";
                                tableContent += "<td><i class=\"gg-arrow-down-r\" onclick=\"downloadDeleteButton('" + item.path + "', 'download')\"></i>&nbsp&nbsp\n";
                                tableContent += "<i class=\"gg-rename\" onclick=\"renameFile('" + item.path + "', '" + item.name + "')\"></i>&nbsp&nbsp\n";
                                tableContent += "<i class=\"gg-trash\" onclick=\"downloadDeleteButton('" + item.path + "', 'delete')\"></i></td></tr>\n\n";
                            });

                            tableContent += "</table>";
                            _("details").innerHTML = tableContent;
                        } else {
                            console.error('Erro na requisição: ' + xmlhttp.status);
                        }
                    };

                    xmlhttp.onerror = function () {
                        console.error('Erro na rede ou falha na requisição.');
                    };

                    xmlhttp.open("GET", "/listfiles?folder=" + encodeURIComponent(folders), true);
                    xmlhttp.send();

                    _("detailsheader").innerHTML = "<h3>Files</h3>";
                    _("updetailsheader").innerHTML = "<h3>Folder Actions: " +
                        "<input type='file' id='fa' multiple style='display:none'>" +
                        "<input type='file' id='fol' webkitdirectory directory multiple style='display:none'>" +
                        "<button onclick=\"_('fa').click()\">Send Files</button>" +
                        "<button onclick=\"_('fol').click()\">Send Folders</button>" +
                        "<button onclick=\"CreateFolder('" + folders + "')\">Create Folder</button></h3>";

                    _("fa").onchange = e => handleFileForm(e.target.files, folders);
                    _("fol").onchange = e => handleFileForm(e.target.files, folders);
                    _("updetails").innerHTML = "";
                }
                function renameFile(filePath, oldName) {
                    var actualFolder = _("actualFolder").value;
                    let fileName = prompt("Enter the new name: ", oldName);
                    if (fileName == null || fileName.trim() === "") {
                        window.alert("Invalid Name");
                    } else {
                        if (!filePath.startsWith("/")) filePath = "/" + filePath;

                        const ajax5 = new XMLHttpRequest();
                        const formdata5 = new FormData();
                        formdata5.append("filePath", filePath);
                        formdata5.append("fileName", fileName);

                        ajax5.open("POST", "/rename", false);
                        ajax5.send(formdata5);

                        _("status").innerHTML = ajax5.responseText;
                        listFilesButton(actualFolder);
                    }
                }
                function downloadDeleteButton(filename, action) {
                    let fullPath;
                    let actualFolder;
                    if (action === "create") {
                        fullPath = filename;
                        const lastSlash = filename.lastIndexOf("/");
                        actualFolder = lastSlash !== -1 ? filename.substring(0, lastSlash) : "";
                        if (actualFolder !== "" && !actualFolder.endsWith("/")) {
                            actualFolder += "/";
                        }
                    } else {
                        fullPath = filename;
                        const lastSlash = filename.lastIndexOf("/");
                        actualFolder = lastSlash !== -1 ? filename.substring(0, lastSlash) : "";
                    }
                    const urltocall = "/file?name=" + fullPath + "&action=" + action;
                    let option;
                    if (action === "delete") {
                        option = confirm("Do you really want to DELETE the file: " + filename + " ?\n\nThis action can't be undone!");
                    }
                    const xmlhttp = new XMLHttpRequest();
                    if (option === true || action === "create") {
                        xmlhttp.open("GET", urltocall, false);
                        xmlhttp.send();
                        _("status").innerHTML = xmlhttp.responseText;
                        listFilesButton(actualFolder);
                    }
                    if (action === "download") {
                        _("status").innerHTML = "";
                        window.open(urltocall, "_blank");
                    }
                }
                function CreateFolder(folders) {
                    let ff = prompt("Folder Name", "").trim();
                    if (ff === "") {
                        window.alert("Invalid Folder Name");
                        return;
                    }
                    const invalidChars = /[<>:"\/\\|?*]/;
                    if (invalidChars.test(ff)) {
                        window.alert("Folder name contains invalid characters.");
                        return;
                    }
                    let actualFolderInput = document.getElementById("actualFolder");
                    let currentFolder = actualFolderInput ? actualFolderInput.value.trim() : "";
                    if (currentFolder.endsWith("/")) {
                        currentFolder = currentFolder.slice(0, -1);
                    }
                    let fullPath = currentFolder ? `${currentFolder}/${ff}` : ff;
                    fullPath = fullPath.replace(/\/{2,}/g, "/");
                    console.log("Creating folder at path:", fullPath);
                    downloadDeleteButton(fullPath, 'create');
                }

                window.addEventListener("load", function () {
                    var dropArea = _("drop-area");
                    dropArea.addEventListener("dragenter", dragEnter, false);
                    dropArea.addEventListener("dragover", dragOver, false);
                    dropArea.addEventListener("dragleave", dragLeave, false);
                    dropArea.addEventListener("drop", drop, false);
                });
                function dragEnter(event) { event.preventDefault(); this.classList.add("highlight"); }
                function dragOver(event) { event.preventDefault(); this.classList.add("highlight"); }
                function dragLeave(event) { event.preventDefault(); this.classList.remove("highlight"); }
                var currentFileIndex = 0;
                var totalSize = 0;
                var totalFiles = 0;
                var totalProgress = 0;
                function writeSendForm() {
                    var uploadform =
                        "<p>Send files</p>" +
                        "<div id=\"file-progress-container\"></div>";
                    _("updetails").innerHTML = uploadform;
                }
                async function drop(event) {
                    event.preventDefault();
                    _("drop-area").classList.remove("highlight");
                    const items = event.dataTransfer.items;
                    const filesQ = [];
                    const promises = [];
                    for (let i = 0; i < items.length; i++) {
                        const entry = items[i].webkitGetAsEntry();
                        if (entry) {
                            promises.push(FileTree(entry, "", filesQ));
                        }
                    }
                    await Promise.all(promises);
                    handleFileForm(filesQ, _("actualFolder").value);
                }
                function FileTree(item, path = "", filesQ) {
                    return new Promise((resolve) => {
                        if (item.isFile) {
                            item.file(function (file) {
                                const fileWithPath = new File([file], path + file.name, { type: file.type });
                                filesQ.push(fileWithPath);
                                resolve();
                            });
                        } else if (item.isDirectory) {
                            const dirReader = item.createReader();
                            dirReader.readEntries((entries) => {
                                const entryPromises = [];
                                for (let i = 0; i < entries.length; i++) {
                                    entryPromises.push(FileTree(entries[i], path + item.name + "/", filesQ));
                                } Promise.all(entryPromises).then(resolve);
                            });
                        } else {
                            resolve();
                        }
                    });
                }
                window.addEventListener("load", function () {
                    listFilesButton("/");
                    systemInfo();
                });
                let fileQueue = [];
                let activeUploads = 0;
                const maxConcurrentUploads = 3;
                function handleFileForm(files, folder) {
                    writeSendForm();
                    fileQueue = Array.from(files);
                    totalFiles = fileQueue.length;
                    completedFiles = 0;
                    activeUploads = 0;
                    for (let i = 0; i < maxConcurrentUploads; i++) {
                        processNextUpload(folder);
                    }
                }
                function processNextUpload(folder) {
                    if (fileQueue.length === 0) {
                        if (activeUploads === 0) {
                            _("status").innerHTML = "Upload Complete";
                            var actualFolder = _("actualFolder").value;
                            listFilesButton(actualFolder);
                        }
                        return;
                    }
                    if (activeUploads >= maxConcurrentUploads) return;
                    const file = fileQueue.shift();
                    activeUploads++;
                    uploadFile(folder, file)
                        .then(() => {
                            activeUploads--;
                            completedFiles++;
                            _("status").innerHTML = `Uploaded ${completedFiles} of ${totalFiles} files.`;
                            processNextUpload(folder);
                        })
                        .catch(() => {
                            activeUploads--;
                            _("status").innerHTML = "Upload Failed";
                            processNextUpload(folder);
                        });
                }
                function uploadFile(folder, file) {
                    return new Promise((resolve, reject) => {
                        const progressBarId = `${file.name}-progressBar`;
                        if (!_(progressBarId)) {
                            var fileProgressDiv = document.createElement("div");
                            fileProgressDiv.innerHTML = `<p>${file.name}: <progress id="${progressBarId}" value="0" max="100" style="width:100%;"></progress></p>`;
                            _("file-progress-container").appendChild(fileProgressDiv);
                        }
                        var formdata = new FormData();
                        const targetPath = folder.endsWith("/") ? folder + file.name : folder + "/" + file.name;
                        formdata.append("file", file, targetPath);
                        var ajax = new XMLHttpRequest();
                        ajax.upload.addEventListener("progress", function (event) {
                            if (event.lengthComputable) {
                                var percent = (event.loaded / event.total) * 100;
                                _(progressBarId).value = Math.round(percent);
                            }
                        }, false);
                        ajax.addEventListener("load", () => resolve(), false);
                        ajax.addEventListener("error", () => reject(), false);
                        ajax.addEventListener("abort", () => reject(), false);
                        ajax.open("POST", "/upload");
                        ajax.send(formdata);
                    });
                }
            </script>
        </body>
    </html>